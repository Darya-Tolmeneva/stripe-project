{% extends "base.html" %}
{% load static %}
{% block title %}Корзина{% endblock %}


{% block content %}
    <h1>Корзина</h1>
    {% if items %}
        <div class="cart-summary">
            <ul>
                {% for item in items %}
                    <li class="cart-item">
                        <span class="item-name">{{ item.item.name }}</span>
                        <span class="quantity-input">{{ item.quantity }}</span>
                        <span class="item-price">{{ item.price }}</span>
                    </li>
                {% endfor %}
            </ul>
            <hr>
            <p>SUMMARY: {{ subtotal|floatformat:2 }} ₽</p>
            <p>DISCOUNT: {{ discount_amount|floatformat:2 }} ₽</p>
            <p>TAXES: {{ tax_amount|floatformat:2 }} ₽</p>
            <hr>
            <h2>TOTAL: {{ total_price|floatformat:2 }} ₽</h2>
        </div>

        <button id="checkout-button" class="btn btn-primary rounded-button">Оформить заказ</button>
    {% else %}
        <p>Корзина пуста</p>
    {% endif %}
    <button onclick="window.location.href='/'" class="back-button rounded-button">
        <i class="fas fa-arrow-left"></i> Назад
    </button>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.getElementById('checkout-button').addEventListener('click', function () {
            fetch('/buy/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    items: [
                        {% for item in items %}
                            {id: "{{ item.item.id }}", quantity: {{ item.quantity}}},
                        {% endfor %}
                    ],
                    total_price: {{ total_price|floatformat:2|default:0 }}
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.session_id) {
                        const stripe = Stripe(data.stripe_public_key);
                        stripe.redirectToCheckout({sessionId: data.session_id})
                            .then(function (result) {
                                if (result.error) {
                                    console.error('Redirect error:', result.error);
                                }
                            });
                    } else {
                        console.error('Ошибка: Не получен session_id');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        });
    </script>
{% endblock %}